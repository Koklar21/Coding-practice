from __future__ import annotations

import datetime
import logging
import time
import random
from typing import Any, Dict, List, Tuple

SYSTEM_ID = "AEGIS-42-NODE-01"

# --- Logging (structured, ISO timestamps) ---
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(levelname)-8s | %(module)-10s | %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S",
)


class SecurityNodeError(Exception):
    """Base exception for all security node operational failures."""


class OperationalConstraintError(SecurityNodeError):
    """Raised when an operation violates system constraints (e.g., max layers)."""


class SecurityNode:
    """
    The Aegis-42 Multilayer Defensive Scaffolding.

    Features:
      - Watchtower scan hooks
      - Self-repair trigger logic
      - PsyOp (Theseus Protocol) with cognitive stress injection

    Notes:
      - This class focuses on orchestration and simulation. Plug real sensors
        and watchtowers via your ingestion layer.
    """

    VALID_SEVERITIES: set[str] = {"Low", "Medium", "High", "Critical", "PsyOp"}
    MAX_FIREWALL_LAYERS: int = 42

    def __init__(self) -> None:
        # Persistent logs
        self.event_log: List[Tuple[datetime.datetime, str]] = []
        self.threat_log: List[Dict[str, Any]] = []
        self.system_status: Dict[str, str] = {}

        # Defensive state
        self.firewall_layer: int = 0
        self.security_mode: str = "Normal"
        self.deception_active: bool = False

        # Theseus Protocol state
        self.theseus_state: Dict[str, bool] = {
            "Core_Data_Locus": False,
            "Auth_Service_ID": False,
            "Firewall_Signature_Morph": False,
        }
        self.cognitive_load_index: int = 0

        # Bootstrap status
        self._log_event(f"[{SYSTEM_ID}] Operational Startup Sequence Initiated.")
        self._update_system_status(
            "Firewall", f"Inactive (Layer {self.firewall_layer}/{self.MAX_FIREWALL_LAYERS})"
        )
        self._update_system_status("PsyOp_Module", "Dormant (Theseus Protocol Offline)")
        self._update_system_status("Watchtower", "Standby")

    # ----------------- Logging helpers -----------------

    def _log_event(self, message: str, module: str = "SYSTEM") -> None:
        ts = datetime.datetime.utcnow()
        self.event_log.append((ts, message))
        logging.info(f"[{module}] {message}")

    def _log_threat(
        self, source: str, description: str, severity: str, module: str = "THREAT_INT"
    ) -> None:
        if severity not in self.VALID_SEVERITIES:
            raise SecurityNodeError(f"Invalid severity level: {severity}")

        entry = {
            "timestamp": datetime.datetime.utcnow(),
            "source": source,
            "description": description,
            "severity": severity,
            "module": module,
        }
        self.threat_log.append(entry)

        if severity == "PsyOp":
            logging.debug(f"[{module}] DECEPTION LOG: {source} | {description}")
        elif severity in {"High", "Critical"}:
            logging.critical(f"[{module}] ALERT! {source} | {severity} | {description}")
        else:
            logging.warning(f"[{module}] {source} | {severity} | {description}")

    def _update_system_status(self, component: str, status: str) -> None:
        old = self.system_status.get(component, "Unknown")
        self.system_status[component] = status
        self._log_event(
            f"{component} status changed from '{old}' to '{status}'", module="STATUS_REG"
        )

    # ----------------- Core defensive ops -----------------

    def advance_firewall(self) -> None:
        """Engage one additional defensive layer."""
        if self.firewall_layer >= self.MAX_FIREWALL_LAYERS:
            raise OperationalConstraintError(
                f"Firewall is at maximum Layer {self.MAX_FIREWALL_LAYERS}. Deployment complete."
            )

        self.firewall_layer += 1
        c2 = round((self.firewall_layer ** 1.5) * 0.42, 2)
        self._update_system_status(
            "Firewall",
            f"Active (Layer {self.firewall_layer}/{self.MAX_FIREWALL_LAYERS}, C² Metric: {c2})",
        )
        self._log_event(f"Layer {self.firewall_layer} deployed. C² Rating: {c2}", module="FIREWALL")

    def _ensure_min_firewall(self, minimum: int) -> int:
        """
        Ensure firewall has at least 'minimum' layers.
        Returns number of layers deployed during the operation.
        """
        if minimum < 0:
            minimum = 0
        if minimum > self.MAX_FIREWALL_LAYERS:
            minimum = self.MAX_FIREWALL_LAYERS

        deployed = 0
        while self.firewall_layer < minimum:
            self.advance_firewall()
            deployed += 1
        return deployed

    def switch_security_mode(self, mode: str) -> None:
        valid = {"Normal", "Elevated", "Lockdown"}
        if mode not in valid:
            raise SecurityNodeError(f"Invalid operational mode: {mode}")

        if mode == self.security_mode:
            return

        prev = self.security_mode
        self.security_mode = mode
        self._log_event(f"Operational Stance escalated: '{prev}' -> '{mode}'", module="MODE_CHANGE")

        if mode == "Lockdown":
            # Lockdown disables deception and stabilizes logging for forensics.
            self.disable_psyop_defense("Lockdown: Forensics Integrity Assurance")

    def log_threat(self, source: str, description: str, severity: str) -> None:
        self._log_threat(source, description, severity)

        if severity == "Critical":
            self.switch_security_mode("Lockdown")
            self.watchtower_scan(level="Full_Response")
        elif severity == "High" and not self.deception_active:
            self.switch_security_mode("Elevated")
            self.deploy_psyop_defense(f"Active probe detected from {source}")
        else:
            self.watchtower_scan(level="Passive_Scan")

    # ----------------- Self-repair + watchtower orchestration -----------------

    def _execute_self_repair(self, target: str, action: str) -> None:
        self._log_event(
            f"Initiating self-repair sequence. Target: {target}. Action: {action}", module="SELF_REPAIR"
        )

        if target == "FIREWALL_UNDERDEPLOYED":
            deployed = self._ensure_min_firewall(5)
            self._log_event(
                f"Firewall auto-deployed {deployed} layer(s) to reach minimum operational level.",
                module="SELF_REPAIR",
            )

        elif target == "SYSTEM_INTEGRITY":
            if self.system_status.get("Watchtower") != "Monitoring":
                self._update_system_status("Watchtower", "Monitoring")
            self._log_event("System integrity restored. Core services validated.", module="SELF_REPAIR")

    def watchtower_scan(self, level: str = "Standard_Scan") -> None:
        self._update_system_status("Watchtower", f"Scanning ({level})...")

        # Trigger repair if mode is elevated/lockdown but firewall < L5
        if self.security_mode != "Normal" and self.firewall_layer < 5:
            self._log_event(
                "INTEGRITY VIOLATION: Firewall under-deployed for current security mode. Initiating repair.",
                module="WATCHTOWER",
            )
            self._execute_self_repair("FIREWALL_UNDERDEPLOYED", "Auto-deploy to Layer 5")

        # PsyOp noise injection while deception is active
        if self.deception_active:
            self._inject_cognitive_stress(random.randint(5, 15))

        self._update_system_status("Watchtower", f"Complete ({level}). Mode: {self.security_mode}")

    # ----------------- PsyOp / Theseus Protocol -----------------

    def deploy_psyop_defense(self, trigger_message: str) -> None:
        if self.deception_active:
            self._log_event(
                "PsyOp module already active. Cycling identity morph; refreshing stress.",
                module="PSYOP_MGR",
            )
            self._morph_theseus_state()
            self._inject_cognitive_stress(20)
            return

        self.deception_active = True
        self.cognitive_load_index = 50
        self._morph_theseus_state(initial=True)
        self._update_system_status("PsyOp_Module", "ACTIVE - Theseus Protocol Engaged")

        decoy_ip = f"172.16.{random.randint(1, 254)}.{random.randint(1, 254)}"
        self._log_threat(
            source="Paradox_Lure",
            description=(
                f"SUCCESSFUL INFILTRATION: Adversary gained read access to Decoy Locus {decoy_ip}. "
                f"Begin extraction (Status: 0% complete). Trigger: {trigger_message}"
            ),
            severity="PsyOp",
            module="PSYOP_LURE",
        )
        self._log_event("Paradoxical confirmation lure deployed.", module="PSYOP_MGR")

    def _morph_theseus_state(self, initial: bool = False) -> None:
        for component in list(self.theseus_state.keys()):
            flip = initial or (random.random() > 0.4)
            if not flip:
                continue

            self.theseus_state[component] = not self.theseus_state[component]
            action = "REPLACED (Decoy)" if self.theseus_state[component] else "REVERTED (Original)"
            self._log_event(f"THESEUS MORPH: {component} component {action}.", module="PSYOP_MORPH")

            if self.theseus_state[component]:
                self._log_threat(
                    source="Status_Contradiction",
                    description=(
                        f"{component} reports successful read access to its OWN log data, "
                        f"but system reports 'Not Found'."
                    ),
                    severity="PsyOp",
                    module="PSYOP_MORPH",
                )

    def _inject_cognitive_stress(self, magnitude: int) -> None:
        magnitude = max(0, magnitude)
        self.cognitive_load_index = min(100, self.cognitive_load_index + magnitude)

        for _ in range(magnitude):
            decoy_service = random.choice(["RPC_Server_1", "DB_Mirror_4", "Telemetry_Sink_A"])
            decoy_ip = f"10.0.0.{random.randint(1, 254)}"
            msg = random.choice(
                [
                    f"[{decoy_service}] Fatal error accessing non-existent file path: "
                    f"/usr/local/temp/0x{random.getrandbits(12):x}.log",
                    f"[{decoy_ip}] TCP handshake successful, checksum failed on port {random.randint(40000, 60000)}.",
                    f"Watchdog detected 5s heartbeat delay on system {random.choice(['A', 'B', 'C'])}, autocorrected.",
                    f"Authentication attempt successful (User: ghost_{random.randint(100, 999)}), source IP unlogged.",
                ]
            )
            self._log_threat("Cognitive_Load", msg, "Low", module="STRESS_ENGINE")

        self._update_system_status("Cognitive_Stress_Index", f"{self.cognitive_load_index}%")
        self._log_event(
            f"Injected {magnitude} data points. Stress Index now {self.cognitive_load_index}%.",
            module="STRESS_ENGINE",
        )

    def disable_psyop_defense(self, reason: str) -> None:
        if not self.deception_active:
            self._log_event("PsyOp module already dormant. No action taken.", module="PSYOP_MGR")
            return

        self.deception_active = False
        self.cognitive_load_index = 0
        for component in self.theseus_state:
            self.theseus_state[component] = False

        self._update_system_status("PsyOp_Module", "Dormant (Theseus Protocol Offline)")
        self._update_system_status("Cognitive_Stress_Index", "0% (Stabilized)")
        self._log_event(f"PsyOp Module deactivated and identities stabilized. Reason: {reason}", module="PSYOP_MGR")

    # ----------------- Reporting -----------------

    def get_summary(self) -> Dict[str, Any]:
        return {
            "System_ID": SYSTEM_ID,
            "Total_Events": len(self.event_log),
            "Total_Threats": len(self.threat_log),
            "Firewall_Layer": f"{self.firewall_layer}/{self.MAX_FIREWALL_LAYERS}",
            "Security_Mode": self.security_mode,
            "PsyOp_Active": self.deception_active,
            "Cognitive_Load_Index": f"{self.cognitive_load_index}%",
            "Theseus_State": dict(self.theseus_state),
            "Status_Components": list(self.system_status.keys()),
        }

    def get_logs(self) -> Dict[str, Any]:
        return {
            "Event_Log": [(ts.isoformat(), msg) for ts, msg in self.event_log],
            "Threat_Log": [{**e, "timestamp": e["timestamp"].isoformat()} for e in self.threat_log],
            "System_Status_Register": dict(self.system_status),
        }


if __name__ == "__main__":
    # Scenario demo
    print("\n--- AEGIS-42: SCENARIO INITIATION (Deep PsyOp Test) ---\n")
    node = SecurityNode()

    # Under-deploy to trigger self-repair later
    for _ in range(3):
        node.advance_firewall()

    print("\n--- STAGE 1: HIGH-LEVEL THREAT & PSYOP DEPLOYMENT ---")
    node.log_threat("203.0.113.15", "Stealthy credential stuffing against exposed API.", "High")

    print(f"\n[Pre-Scan Check] Firewall Layer: {node.firewall_layer}, Mode: {node.security_mode}")

    print("\n--- STAGE 2: WATCHTOWER RUNS & EXECUTES SELF-REPAIR (Auto-deploy to L5) ---")
    node.watchtower_scan()

    for i in range(2):
        time.sleep(0.01)
        node.watchtower_scan()
        if i == 0:
            node._log_threat(
                source="Adversary_Action",
                description=(
                    "Malware signature successfully deployed to FireWall_Signature_Morph Locus. Reporting 100% success."
                ),
                severity="High",
                module="ADVERSARY_SIM",
            )
            node._log_threat(
                source="System_Integrity_Check",
                description="FireWall_Signature_Morph integrity check passed. No anomalies detected. Reporting 0% change.",
                severity="PsyOp",
                module="PSYOP_COUNTER",
            )

    print("\n--- STAGE 3: CRITICAL THREAT & LOCKDOWN (Stabilization) ---")
    node.log_threat("198.51.100.33", "Brute-force attempt on core vault access key identified.", "Critical")

    import json

    print("\n--- FINAL TELEMETRY REPORT ---\n")
    summary = node.get_summary()
    print("SUMMARY:")
    print(json.dumps(summary, indent=4))

    print("\n--- FORENSIC LOG EXCERPT (PsyOp/Paradox) ---")
    psyop_logs = [
        t for t in node.get_logs()["Threat_Log"] if t["severity"] in ["PsyOp", "Low", "High"]
    ]
    for log in psyop_logs[-15:]:
        print(f"[{log['timestamp'][:19]}] [{log['module']}] ({log['severity']}) -> {log['description']}")
    print(f"\nFinal Cognitive Load Index: {summary['Cognitive_Load_Index']} (Should be 0% after Lockdown)")
    print("\n--- SCENARIO END ---")